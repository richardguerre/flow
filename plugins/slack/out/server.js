"use strict";const O=e=>({plugin:e}),$="post-to-slack",M=e=>{const k=e!=null&&e.withLinear?'{{#linear-issue-exists}} - <a href="{{linear-issue-link}}">{{linear-issue-id}}</a>{{/linear-issue-exists}}':"";return`Plan for today
<ul>
  {{#tasks}}
    <li>{{slack-status}} {{title-without-tags}}${k}</li>
  {{else}}
    <li>No tasks</li> 
  {{/tasks}}
  {{! Do not remove the extra curly braces around the slack-future-tasks block.}}
  {{{{slack-future-tasks}}}}
    <li>{{slack-status}} {{title-without-tags}}${k}</li>
  {{{{/slack-future-tasks}}}}
</ul>`},y="account-tokens",A="slack-cached-channels",L=O(e=>{const k="update-slack-messages",I="update-cached-channels",S=async()=>{const t=await e.store.getPluginItem(y);if(!t)throw new e.GraphQLError("User not authenticated.",{extensions:{code:"NOT_AUTHENTICATED",userFriendlyMessage:"You are not authenticated and will need to connect your Slack account(s) first."}});return t.value},p={TODO:"",DONE:"✅",CANCELED:"❌"},_=async t=>{const a=e.html.parse(t).querySelectorAll("slack-status").map(c=>{var h;if(!c.attributes["data-task-id"])return null;const o=(h=e.decodeGlobalId(c.attributes["data-task-id"]))==null?void 0:h.id;return o?parseInt(o):null}).filter(c=>c!==null);return await e.prisma.task.findMany({where:{id:{in:a}}}).then(c=>new Map(c.map(o=>[o.id,o])))},N=t=>e.html.parse(t).querySelectorAll("slack-message").map(i=>({teamId:i.attributes["data-team-id"],channelId:i.attributes["data-channel-id"],ts:i.attributes["data-ts"]})),E=async t=>{var c,o;const a=await S().catch(()=>null),i=[];for(const h in a){const d=a[h],n=d.access_token??d.authed_user.access_token,u=await fetch("https://slack.com/api/conversations.list?exclude_archived=true&limit=999",{headers:{Authorization:`Bearer ${n}`}}).then(async r=>await r.json()).catch(()=>null);if(!(u!=null&&u.ok))continue;i.push(...u.channels.map(r=>({id:r.id,name:r.name,team:{id:d.team.id,name:d.team.name,icon:d.team.icon.image_44}})));let s=(c=u.response_metadata)==null?void 0:c.next_cursor;for(;s;){const r=await fetch(`https://slack.com/api/conversations.list?exclude_archived=true&limit=999&cursor=${s}`,{headers:{Authorization:`Bearer ${n}`}}).then(async l=>await l.json()).catch(()=>null);if(!(r!=null&&r.ok))break;i.push(...r.channels.map(l=>({id:l.id,name:l.name,team:{id:d.team.id,name:d.team.name,icon:d.team.icon.image_44}}))),s=(o=r.response_metadata)==null?void 0:o.next_cursor}}return i};return{onRequest:async t=>{if(t.path==="/auth")return Response.redirect(`https://slack-api-flow-dev.vercel.app/api/auth?api_endpoint=${e.serverOrigin}/api/plugin/${e.pluginSlug}/auth/callback`);if(t.path==="/auth/callback"){const a=await e.store.getPluginItem(y),{ok:i,...c}=t.body;if(!i)return console.log("❌ Slack auth callback failed - req.body.ok is false"),new Response("req.body.ok is false",{status:500});const o=await fetch(`https://slack.com/api/team.info?team=${c.team.id}`,{headers:{Authorization:`Bearer ${c.access_token??c.authed_user.access_token}`}}).then(async d=>await d.json()).catch(()=>null);if(!o)return console.log("❌ Slack auth callback failed - teamInfo.ok is false"),new Response("Couldn't get user's workspace info.",{status:500});const h={...c,created_at:new Date().toISOString(),team:{...c.team,...o.team}};return await e.store.setSecretItem(y,{...(a==null?void 0:a.value)??{},[h.team.id]:h}),await e.pgBoss.send(I,{}),new Response}return new Response},operations:{workspaces:async()=>{const t=await S().catch(()=>null);return t?{data:{workspaces:Object.entries(t).map(([a,i])=>({connectedAt:i.created_at,teamId:a,teamName:i.team.name,teamIcon:i.team.icon.image_44}))}}:{data:{workspaces:[]}}},getChannels:async t=>{const a=await e.store.getPluginItem(A).then(c=>c==null?void 0:c.value).catch(()=>null),i=e.dayjs(a==null?void 0:a.updatedAt).isAfter(e.dayjs().subtract(1,"minute"));if(t.forceRefresh&&!i){const c=await E(),o=e.dayjs().toISOString();return await e.store.setSecretItem(A,{updatedAt:o,channels:c}),{data:{channels:c,lastCachedAt:o}}}return{data:{channels:(a==null?void 0:a.channels)??[],lastCachedAt:(a==null?void 0:a.updatedAt)??e.dayjs().toISOString()}}},postMessage:async t=>{if(!t.channels.length)throw new e.GraphQLError("No channels provided.",{extensions:{code:"NO_CHANNELS_PROVIDED",userFriendlyMessage:"No channels selected. Please select at least one channel."}});const a=await S().catch(()=>null);if(!a)throw new e.GraphQLError("User not authenticated.",{extensions:{code:"NOT_AUTHENTICATED",userFriendlyMessage:"You are not authenticated and will need to connect your Slack account(s) first."}});const i=N(t.message);if(i.length){const n=e.dayjs(i[0].ts).toISOString();return e.pgBoss.send(k,{date:n},{startAfter:e.dayjs().add(10,"seconds").toISOString()}),{data:{ok:!0,messages:[]}}}const c=await _(t.message),o=e.html.parse(t.message);o.querySelectorAll("slack-status").forEach(n=>{var l;if(!n.attributes["data-task-id"])return;const u=(l=e.decodeGlobalId(n.attributes["data-task-id"]))==null?void 0:l.id;if(!u)return;const s=parseInt(u);if(!s)return;const r=c.get(s);r&&n.replaceWith(p[r.status])}),o.querySelectorAll("slack-message").forEach(n=>{n.replaceWith("")}),o.querySelectorAll("li").forEach(n=>{n.querySelectorAll("p").forEach(u=>{u.replaceWith(u.innerHTML)})}),o.querySelectorAll("slack-future-tasks").forEach(n=>{n.parentNode.tagName==="P"&&(n=n.parentNode),n.parentNode.tagName==="LI"&&(n=n.parentNode),n.replaceWith("")});const h=e.html.toSlack(o.toString()),d=[];for(const n of t.channels){const u=a[n.teamId].authed_user.access_token,s=await fetch(`https://slack.com/api/chat.postMessage?channel=${n.channelId}&blocks=${JSON.stringify(h)}`,{headers:{Authorization:`Bearer ${u}`}}).then(async r=>await r.json());if(!s.ok){const r=await fetch(`https://slack.com/api/conversations.info?channel=${n.channelId}`,{headers:{Authorization:`Bearer ${u}`}}).then(async l=>await l.json()).catch(()=>null);throw new e.GraphQLError("Couldn't post message.",{extensions:{code:"COULDNT_POST_MESSAGE",userFriendlyMessage:`Couldn't post message to channel ${r!=null&&r.channel.name?`#${r==null?void 0:r.channel.name}`:"Unknonwn"}. The message may be too complex.`}})}d.push({teamId:n.teamId,channelId:n.channelId,ts:s.ts})}return{data:{ok:!0,messages:d}}}},onUpdateTaskStatusEnd:async t=>{const a=e.dayjs(t.task.date);await e.pgBoss.send(k,{date:a.toISOString()})},onCreateTask:async t=>{const a=e.dayjs(t.task.date);await e.pgBoss.send(k,{date:a.toISOString()})},onUpdateTaskEnd:async t=>{const a=e.dayjs(t.task.date);await e.pgBoss.send(k,{date:a.toISOString()})},onAddRoutineStepEnd:async t=>{if(t.step.stepSlug===$){const a=await e.getInstalledPlugins();await e.prisma.template.upsert({where:{slug:`${e.pluginSlug}-${t.step.stepSlug}`},create:{slug:`${e.pluginSlug}-${t.step.stepSlug}`,template:M({withLinear:a.some(i=>i.slug==="linear")}),routineStepId:t.step.id},update:{routineStepId:t.step.id}})}},handlebars:{helpers:{status:function(){return!("status"in this)||!("id"in this)?"":new e.Handlebars.SafeString(`<slack-status data-task-id="Task_${this.id}">${p[this.status]}</slack-status>`)},"future-tasks":async function(t){if(!t||!("fn"in t))return"";const a=t.hash.filter??{},i=e.html.escape(JSON.stringify(a)),c=await t.fn({});return new e.Handlebars.SafeString(`<slack-future-tasks filter="${i}">${c}</slack-future-tasks>`)}}},handlePgBossWork:t=>[t(k,async a=>{const i=a.data,c=await S().catch(()=>null);if(!c)return;const o=await e.prisma.note.findFirst({where:{date:i.date}});if(!o)return;const h=await _(o.content),d=N(o.content);if(!d.length)return;const n=e.html.parse(o.content);for(let s of n.querySelectorAll("slack-future-tasks")){const r=s.innerHTML;let l={};try{const g=e.html.unescape(s.getAttribute("filter")??"{}"),w=await e.renderTemplate(g,{});l=JSON.parse(w)}catch{}const m=await e.prisma.task.findMany({...l,where:{date:i.date,id:{notIn:Array.from(h.keys())},...(l==null?void 0:l.where)??{}},include:{tags:!0,pluginDatas:!0,item:{select:{id:!0}},...(l==null?void 0:l.include)??{}}}).then(g=>g.map(w=>{const b=e.html.parse(w.title);return b.querySelectorAll("p").forEach(T=>{T.replaceWith(T.innerHTML)}),{...w,title:new e.Handlebars.SafeString(b.toString())}}));let f="";for(const g of m)f+=await e.renderTemplate(r,g);s.parentNode.tagName==="P"&&(s=s.parentNode),s.parentNode.tagName==="LI"&&(s=s.parentNode),s.replaceWith(f)}n.querySelectorAll("slack-status").forEach(s=>{var f;if(!s.attributes["data-task-id"])return;const r=(f=e.decodeGlobalId(s.attributes["data-task-id"]))==null?void 0:f.id;if(!r)return;const l=parseInt(r);if(!l)return;const m=h.get(l);m?s.replaceWith(p[m.status]):s.replaceWith(s.innerHTML)}),n.querySelectorAll("slack-message").forEach(s=>{s.replaceWith("")}),n.querySelectorAll("li").forEach(s=>{s.querySelectorAll("p").forEach(r=>{r.replaceWith(r.innerHTML)})});const u=e.html.toSlack(n.toString());for(const s of d){const r=c[s.teamId].authed_user.access_token,l=await fetch(`https://slack.com/api/chat.update?channel=${s.channelId}&ts=${s.ts}&blocks=${JSON.stringify(u)}`,{headers:{Authorization:`Bearer ${r}`}}).then(async m=>await m.json());if(!l.ok){console.log("❌ Slack message update failed - res.ok is false",l.error);continue}console.log("✅ Slack message update successful")}}),t(I,async a=>{const i=await E();await e.store.setSecretItem(A,{updatedAt:e.dayjs().toISOString(),channels:i})})]}});module.exports=L;
