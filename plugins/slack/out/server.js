"use strict";const y=e=>({plugin:e}),I="post-to-slack",_=`Plan for today
{{#tasks}}
  <ul>
    <li>
      <p>{{slack-status}} {{title}}</p>
    </li>
  </ul>
{{else}}
  <p>No tasks today</p>
{{/tasks}}
`,f="account-tokens",A=y(e=>{const g="update-task-status",k=async()=>{const a=await e.store.getPluginItem(f);if(!a)throw new e.GraphQLError("User not authenticated.",{extensions:{code:"NOT_AUTHENTICATED",userFriendlyMessage:"You are not authenticated and will need to connect your Slack account(s) first."}});return a.value},p={TODO:"",DONE:"✅",CANCELED:"❌"},w=async a=>{const c=e.parseHtml(a).querySelectorAll("slack-status").map(s=>{var o;if(!s.attributes["data-task-id"])return null;const r=(o=e.decodeGlobalId(s.attributes["data-task-id"]))==null?void 0:o.id;return r?parseInt(r):null}).filter(s=>s!==null);return await e.prisma.task.findMany({where:{id:{in:c}}}).then(s=>new Map(s.map(r=>[r.id,r])))};return{onRequest:async a=>{if(a.path==="/auth")return Response.redirect(`https://slack-api-flow-dev.vercel.app/api/auth?api_endpoint=${e.serverOrigin}/api/plugin/${e.pluginSlug}/auth/callback`);if(a.path==="/auth/callback"){const c=await e.store.getPluginItem(f),{ok:l,...s}=a.body;if(!l)return console.log("❌ Slack auth callback failed - req.body.ok is false"),new Response("req.body.ok is false",{status:500});const r=await fetch(`https://slack.com/api/team.info?team=${s.team.id}`,{headers:{Authorization:`Bearer ${s.access_token??s.authed_user.access_token}`}}).then(async n=>await n.json()).catch(()=>null);if(!r)return console.log("❌ Slack auth callback failed - teamInfo.ok is false"),new Response("Couldn't get user's workspace info.",{status:500});const o={...s,created_at:new Date().toISOString(),team:{...s.team,...r.team}};return await e.store.setSecretItem(f,{...(c==null?void 0:c.value)??{},[o.team.id]:o}),new Response}return new Response},operations:{workspaces:async()=>{const a=await k().catch(()=>null);return a?{data:{workspaces:Object.entries(a).map(([c,l])=>({connectedAt:l.created_at,teamId:c,teamName:l.team.name,teamIcon:l.team.icon.image_44}))}}:{data:{workspaces:[]}}},getChannels:async a=>{const c=await k().catch(()=>null),l=[];for(const s in c){const r=c[s],o=await fetch("https://slack.com/api/conversations.list",{headers:{Authorization:`Bearer ${r.authed_user.access_token}`}}).then(async n=>await n.json()).catch(()=>null);o!=null&&o.ok&&l.push(...o.channels.map(n=>({id:n.id,name:n.name,team:{id:r.team.id,name:r.team.name,icon:r.team.icon.image_44}})))}return{data:{channels:l}}},postMessage:async a=>{if(!a.channels.length)throw new e.GraphQLError("No channels provided.",{extensions:{code:"NO_CHANNELS_PROVIDED",userFriendlyMessage:"No channels selected. Please select at least one channel."}});const c=await k().catch(()=>null);if(!c)throw new e.GraphQLError("User not authenticated.",{extensions:{code:"NOT_AUTHENTICATED",userFriendlyMessage:"You are not authenticated and will need to connect your Slack account(s) first."}});const l=await w(a.message),s=e.parseHtml(a.message);s.querySelectorAll("slack-status").forEach(n=>{var u;if(!n.attributes["data-task-id"])return;const i=(u=e.decodeGlobalId(n.attributes["data-task-id"]))==null?void 0:u.id;if(!i)return;const d=parseInt(i);if(!d)return;const t=l.get(d);t&&n.replaceWith(p[t.status])}),s.querySelectorAll("slack-message").forEach(n=>{n.replaceWith("")}),s.querySelectorAll("li").forEach(n=>{n.querySelectorAll("p").forEach(i=>{i.replaceWith(i.innerHTML)})});const r=e.htmlToSlack(s.toString()),o=[];for(const n of a.channels){const i=c[n.teamId].authed_user.access_token,d=await fetch(`https://slack.com/api/chat.postMessage?channel=${n.channelId}&blocks=${JSON.stringify(r)}`,{headers:{Authorization:`Bearer ${i}`}}).then(async t=>await t.json());if(!d.ok){const t=await fetch(`https://slack.com/api/conversations.info?channel=${n.channelId}`,{headers:{Authorization:`Bearer ${i}`}}).then(async u=>await u.json()).catch(()=>null);throw new e.GraphQLError("Couldn't post message.",{extensions:{code:"COULDNT_POST_MESSAGE",userFriendlyMessage:`Couldn't post message to channel ${t!=null&&t.channel.name?`#${t==null?void 0:t.channel.name}`:"Unknonwn"}. The message may be too complex.`}})}o.push({teamId:n.teamId,channelId:n.channelId,ts:d.ts})}return{data:{ok:!0,messages:o}}}},onUpdateTaskStatusEnd:async a=>{const c=e.dayjs();await e.pgBoss.send(g,{date:c.toISOString()})},onAddRoutineStepEnd:async a=>{a.step.stepSlug===I&&await e.prisma.template.upsert({where:{slug:`${e.pluginSlug}-${a.step.stepSlug}`},create:{slug:`${e.pluginSlug}-${a.step.stepSlug}`,template:_,routineStepId:a.step.id},update:{routineStepId:a.step.id}})},handlebars:{helpers:{status:function(){return!("status"in this)||!("id"in this)?"":new e.Handlebars.SafeString(`<slack-status data-task-id="Task_${this.id}">${p[this.status]}</slack-status>`)}}},handlePgBossWork:a=>[a(g,async c=>{const l=c.data,s=await e.prisma.note.findFirst({where:{date:l.date}});if(!s)return;const r=e.parseHtml(s.content).querySelectorAll("slack-message").map(t=>({teamId:t.attributes["data-team-id"],channelId:t.attributes["data-channel-id"],ts:t.attributes["data-ts"]}));if(!r.length)return;const o=await k().catch(()=>null);if(!o)return;const n=await w(s.content),i=e.parseHtml(s.content);i.querySelectorAll("slack-status").forEach(t=>{var S;if(!t.attributes["data-task-id"])return;const u=(S=e.decodeGlobalId(t.attributes["data-task-id"]))==null?void 0:S.id;if(!u)return;const h=parseInt(u);if(!h)return;const m=n.get(h);m&&t.replaceWith(p[m.status])}),i.querySelectorAll("slack-message").forEach(t=>{t.replaceWith("")}),i.querySelectorAll("li").forEach(t=>{t.querySelectorAll("p").forEach(u=>{u.replaceWith(u.innerHTML)})});const d=e.htmlToSlack(i.toString());for(const t of r){const u=o[t.teamId].authed_user.access_token,h=await fetch(`https://slack.com/api/chat.update?channel=${t.channelId}&ts=${t.ts}&blocks=${JSON.stringify(d)}`,{headers:{Authorization:`Bearer ${u}`}}).then(async m=>await m.json());if(!h.ok){console.log("❌ Slack message update failed - res.ok is false",h.error);continue}console.log("✅ Slack message update successful")}})]}});module.exports=A;
