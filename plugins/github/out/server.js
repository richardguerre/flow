"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const te=e=>({plugin:e});function T(){return typeof navigator=="object"&&"userAgent"in navigator?navigator.userAgent:"<environment undetectable>"}function re(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var S={exports:{}},ne=L;function L(e,t,r,i){if(typeof r!="function")throw new Error("method for before hook must be a function");return i||(i={}),Array.isArray(t)?t.reverse().reduce(function(n,s){return L.bind(null,e,s,n,i)},r)():Promise.resolve().then(function(){return e.registry[t]?e.registry[t].reduce(function(n,s){return s.hook.bind(null,n,i)},r)():r(i)})}var ie=ae;function ae(e,t,r,i){var n=i;e.registry[r]||(e.registry[r]=[]),t==="before"&&(i=function(s,a){return Promise.resolve().then(n.bind(null,a)).then(s.bind(null,a))}),t==="after"&&(i=function(s,a){var o;return Promise.resolve().then(s.bind(null,a)).then(function(c){return o=c,n(o,a)}).then(function(){return o})}),t==="error"&&(i=function(s,a){return Promise.resolve().then(s.bind(null,a)).catch(function(o){return n(o,a)})}),e.registry[r].push({hook:i,orig:n})}var se=oe;function oe(e,t,r){if(e.registry[t]){var i=e.registry[t].map(function(n){return n.orig}).indexOf(r);i!==-1&&e.registry[t].splice(i,1)}}var B=ne,ue=ie,ce=se,q=Function.bind,N=q.bind(q);function V(e,t,r){var i=N(ce,null).apply(null,r?[t,r]:[t]);e.api={remove:i},e.remove=i,["before","error","after","wrap"].forEach(function(n){var s=r?[t,n,r]:[t,n];e[n]=e.api[n]=N(ue,null).apply(null,s)})}function le(){var e="h",t={registry:{}},r=B.bind(null,t,e);return V(r,t,e),r}function M(){var e={registry:{}},t=B.bind(null,e);return V(t,e),t}var U=!1;function b(){return U||(console.warn('[before-after-hook]: "Hook()" repurposing warning, use "Hook.Collection()". Read more: https://git.io/upgrade-before-after-hook-to-1.4'),U=!0),M()}b.Singular=le.bind();b.Collection=M.bind();S.exports=b;S.exports.Hook=b;S.exports.Singular=b.Singular;var fe=S.exports.Collection=b.Collection;/*!
 * is-plain-object <https://github.com/jonschlinkert/is-plain-object>
 *
 * Copyright (c) 2014-2017, Jon Schlinkert.
 * Released under the MIT License.
 */function D(e){return Object.prototype.toString.call(e)==="[object Object]"}function W(e){var t,r;return D(e)===!1?!1:(t=e.constructor,t===void 0?!0:(r=t.prototype,!(D(r)===!1||r.hasOwnProperty("isPrototypeOf")===!1)))}var de="9.0.1",he=`octokit-endpoint.js/${de} ${T()}`,ge={method:"GET",baseUrl:"https://api.github.com",headers:{accept:"application/vnd.github.v3+json","user-agent":he},mediaType:{format:""}};function pe(e){return e?Object.keys(e).reduce((t,r)=>(t[r.toLowerCase()]=e[r],t),{}):{}}function z(e,t){const r=Object.assign({},e);return Object.keys(t).forEach(i=>{W(t[i])?i in e?r[i]=z(e[i],t[i]):Object.assign(r,{[i]:t[i]}):Object.assign(r,{[i]:t[i]})}),r}function H(e){for(const t in e)e[t]===void 0&&delete e[t];return e}function j(e,t,r){var n;if(typeof t=="string"){let[s,a]=t.split(" ");r=Object.assign(a?{method:s,url:a}:{url:s},r)}else r=Object.assign({},t);r.headers=pe(r.headers),H(r),H(r.headers);const i=z(e||{},r);return r.url==="/graphql"&&(e&&((n=e.mediaType.previews)!=null&&n.length)&&(i.mediaType.previews=e.mediaType.previews.filter(s=>!i.mediaType.previews.includes(s)).concat(i.mediaType.previews)),i.mediaType.previews=(i.mediaType.previews||[]).map(s=>s.replace(/-preview/,""))),i}function be(e,t){const r=/\?/.test(e)?"&":"?",i=Object.keys(t);return i.length===0?e:e+r+i.map(n=>n==="q"?"q="+t.q.split("+").map(encodeURIComponent).join("+"):`${n}=${encodeURIComponent(t[n])}`).join("&")}var ye=/\{[^}]+\}/g;function me(e){return e.replace(/^\W+|\W+$/g,"").split(/,/)}function ve(e){const t=e.match(ye);return t?t.map(me).reduce((r,i)=>r.concat(i),[]):[]}function P(e,t){return Object.keys(e).filter(r=>!t.includes(r)).reduce((r,i)=>(r[i]=e[i],r),{})}function K(e){return e.split(/(%[0-9A-Fa-f]{2})/g).map(function(t){return/%[0-9A-Fa-f]/.test(t)||(t=encodeURI(t).replace(/%5B/g,"[").replace(/%5D/g,"]")),t}).join("")}function g(e){return encodeURIComponent(e).replace(/[!'()*]/g,function(t){return"%"+t.charCodeAt(0).toString(16).toUpperCase()})}function y(e,t,r){return t=e==="+"||e==="#"?K(t):g(t),r?g(r)+"="+t:t}function h(e){return e!=null}function O(e){return e===";"||e==="&"||e==="?"}function we(e,t,r,i){var n=e[r],s=[];if(h(n)&&n!=="")if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")n=n.toString(),i&&i!=="*"&&(n=n.substring(0,parseInt(i,10))),s.push(y(t,n,O(t)?r:""));else if(i==="*")Array.isArray(n)?n.filter(h).forEach(function(a){s.push(y(t,a,O(t)?r:""))}):Object.keys(n).forEach(function(a){h(n[a])&&s.push(y(t,n[a],a))});else{const a=[];Array.isArray(n)?n.filter(h).forEach(function(o){a.push(y(t,o))}):Object.keys(n).forEach(function(o){h(n[o])&&(a.push(g(o)),a.push(y(t,n[o].toString())))}),O(t)?s.push(g(r)+"="+a.join(",")):a.length!==0&&s.push(a.join(","))}else t===";"?h(n)&&s.push(g(r)):n===""&&(t==="&"||t==="?")?s.push(g(r)+"="):n===""&&s.push("");return s}function Ee(e){return{expand:Te.bind(null,e)}}function Te(e,t){var r=["+","#",".","/",";","?","&"];return e.replace(/\{([^\{\}]+)\}|([^\{\}]+)/g,function(i,n,s){if(n){let o="";const c=[];if(r.indexOf(n.charAt(0))!==-1&&(o=n.charAt(0),n=n.substr(1)),n.split(/,/g).forEach(function(f){var u=/([^:\*]*)(?::(\d+)|(\*))?/.exec(f);c.push(we(t,o,u[1],u[2]||u[3]))}),o&&o!=="+"){var a=",";return o==="?"?a="&":o!=="#"&&(a=o),(c.length!==0?o:"")+c.join(a)}else return c.join(",")}else return K(s)})}function X(e){var u;let t=e.method.toUpperCase(),r=(e.url||"/").replace(/:([a-z]\w+)/g,"{$1}"),i=Object.assign({},e.headers),n,s=P(e,["method","baseUrl","url","headers","request","mediaType"]);const a=ve(r);r=Ee(r).expand(s),/^http/.test(r)||(r=e.baseUrl+r);const o=Object.keys(e).filter(l=>a.includes(l)).concat("baseUrl"),c=P(s,o);if(!/application\/octet-stream/i.test(i.accept)&&(e.mediaType.format&&(i.accept=i.accept.split(/,/).map(l=>l.replace(/application\/vnd(\.\w+)(\.v3)?(\.\w+)?(\+json)?$/,`application/vnd$1$2.${e.mediaType.format}`)).join(",")),r.endsWith("/graphql")&&(u=e.mediaType.previews)!=null&&u.length)){const l=i.accept.match(/[\w-]+(?=-preview)/g)||[];i.accept=l.concat(e.mediaType.previews).map(d=>{const v=e.mediaType.format?`.${e.mediaType.format}`:"+json";return`application/vnd.github.${d}-preview${v}`}).join(",")}return["GET","HEAD"].includes(t)?r=be(r,c):"data"in c?n=c.data:Object.keys(c).length&&(n=c),!i["content-type"]&&typeof n<"u"&&(i["content-type"]="application/json; charset=utf-8"),["PATCH","PUT"].includes(t)&&typeof n>"u"&&(n=""),Object.assign({method:t,url:r,headers:i},typeof n<"u"?{body:n}:null,e.request?{request:e.request}:null)}function Se(e,t,r){return X(j(e,t,r))}function Y(e,t){const r=j(e,t),i=Se.bind(null,r);return Object.assign(i,{DEFAULTS:r,defaults:Y.bind(null,r),merge:j.bind(null,r),parse:X})}var Oe=Y(null,ge);class C extends Error{constructor(t){super(t),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="Deprecation"}}var $={exports:{}},Ae=J;function J(e,t){if(e&&t)return J(e)(t);if(typeof e!="function")throw new TypeError("need wrapper function");return Object.keys(e).forEach(function(i){r[i]=e[i]}),r;function r(){for(var i=new Array(arguments.length),n=0;n<i.length;n++)i[n]=arguments[n];var s=e.apply(this,i),a=i[i.length-1];return typeof s=="function"&&s!==a&&Object.keys(a).forEach(function(o){s[o]=a[o]}),s}}var Q=Ae;$.exports=Q(w);$.exports.strict=Q(Z);w.proto=w(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return w(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return Z(this)},configurable:!0})});function w(e){var t=function(){return t.called?t.value:(t.called=!0,t.value=e.apply(this,arguments))};return t.called=!1,t}function Z(e){var t=function(){if(t.called)throw new Error(t.onceError);return t.called=!0,t.value=e.apply(this,arguments)},r=e.name||"Function wrapped with `once`";return t.onceError=r+" shouldn't be called more than once",t.called=!1,t}var je=$.exports;const ee=re(je);var Ie=ee(e=>console.warn(e)),ke=ee(e=>console.warn(e)),m=class extends Error{constructor(e,t,r){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="HttpError",this.status=t;let i;"headers"in r&&typeof r.headers<"u"&&(i=r.headers),"response"in r&&(this.response=r.response,i=r.response.headers);const n=Object.assign({},r.request);r.request.headers.authorization&&(n.headers=Object.assign({},r.request.headers,{authorization:r.request.headers.authorization.replace(/ .*$/," [REDACTED]")})),n.url=n.url.replace(/\bclient_secret=\w+/g,"client_secret=[REDACTED]").replace(/\baccess_token=\w+/g,"access_token=[REDACTED]"),this.request=n,Object.defineProperty(this,"code",{get(){return Ie(new C("[@octokit/request-error] `error.code` is deprecated, use `error.status`.")),t}}),Object.defineProperty(this,"headers",{get(){return ke(new C("[@octokit/request-error] `error.headers` is deprecated, use `error.response.headers`.")),i||{}}})}},_e="8.1.4";function $e(e){return e.arrayBuffer()}function G(e){var o,c,f;const t=e.request&&e.request.log?e.request.log:console,r=((o=e.request)==null?void 0:o.parseSuccessResponseBody)!==!1;(W(e.body)||Array.isArray(e.body))&&(e.body=JSON.stringify(e.body));let i={},n,s,{fetch:a}=globalThis;if((c=e.request)!=null&&c.fetch&&(a=e.request.fetch),!a)throw new Error("fetch is not set. Please pass a fetch implementation as new Octokit({ request: { fetch }}). Learn more at https://github.com/octokit/octokit.js/#fetch-missing");return a(e.url,{method:e.method,body:e.body,headers:e.headers,signal:(f=e.request)==null?void 0:f.signal,...e.body&&{duplex:"half"}}).then(async u=>{s=u.url,n=u.status;for(const l of u.headers)i[l[0]]=l[1];if("deprecation"in i){const l=i.link&&i.link.match(/<([^>]+)>; rel="deprecation"/),d=l&&l.pop();t.warn(`[@octokit/request] "${e.method} ${e.url}" is deprecated. It is scheduled to be removed on ${i.sunset}${d?`. See ${d}`:""}`)}if(!(n===204||n===205)){if(e.method==="HEAD"){if(n<400)return;throw new m(u.statusText,n,{response:{url:s,status:n,headers:i,data:void 0},request:e})}if(n===304)throw new m("Not modified",n,{response:{url:s,status:n,headers:i,data:await A(u)},request:e});if(n>=400){const l=await A(u);throw new m(Re(l),n,{response:{url:s,status:n,headers:i,data:l},request:e})}return r?await A(u):u.body}}).then(u=>({status:n,url:s,headers:i,data:u})).catch(u=>{if(u instanceof m)throw u;if(u.name==="AbortError")throw u;let l=u.message;throw u.name==="TypeError"&&"cause"in u&&(u.cause instanceof Error?l=u.cause.message:typeof u.cause=="string"&&(l=u.cause)),new m(l,500,{request:e})})}async function A(e){const t=e.headers.get("content-type");return/application\/json/.test(t)?e.json():!t||/^text\/|charset=utf-8$/.test(t)?e.text():$e(e)}function Re(e){return typeof e=="string"?e:"message"in e?Array.isArray(e.errors)?`${e.message}: ${e.errors.map(JSON.stringify).join(", ")}`:e.message:`Unknown error: ${JSON.stringify(e)}`}function I(e,t){const r=e.defaults(t);return Object.assign(function(n,s){const a=r.merge(n,s);if(!a.request||!a.request.hook)return G(r.parse(a));const o=(c,f)=>G(r.parse(r.merge(c,f)));return Object.assign(o,{endpoint:r,defaults:I.bind(null,r)}),a.request.hook(o,a)},{endpoint:r,defaults:I.bind(null,r)})}var k=I(Oe,{headers:{"user-agent":`octokit-request.js/${_e} ${T()}`}}),qe="7.0.2";function Ne(e){return`Request failed due to following response errors:
`+e.errors.map(t=>` - ${t.message}`).join(`
`)}var Ue=class extends Error{constructor(e,t,r){super(Ne(r)),this.request=e,this.headers=t,this.response=r,this.name="GraphqlResponseError",this.errors=r.errors,this.data=r.data,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},De=["method","baseUrl","url","headers","request","query","mediaType"],He=["query","method","url"],x=/\/api\/v3\/?$/;function Pe(e,t,r){if(r){if(typeof t=="string"&&"query"in r)return Promise.reject(new Error('[@octokit/graphql] "query" cannot be used as variable name'));for(const a in r)if(He.includes(a))return Promise.reject(new Error(`[@octokit/graphql] "${a}" cannot be used as variable name`))}const i=typeof t=="string"?Object.assign({query:t},r):t,n=Object.keys(i).reduce((a,o)=>De.includes(o)?(a[o]=i[o],a):(a.variables||(a.variables={}),a.variables[o]=i[o],a),{}),s=i.baseUrl||e.endpoint.DEFAULTS.baseUrl;return x.test(s)&&(n.url=s.replace(x,"/api/graphql")),e(n).then(a=>{if(a.data.errors){const o={};for(const c of Object.keys(a.headers))o[c]=a.headers[c];throw new Ue(n,o,a.data)}return a.data.data})}function R(e,t){const r=e.defaults(t);return Object.assign((n,s)=>Pe(r,n,s),{defaults:R.bind(null,r),endpoint:r.endpoint})}R(k,{headers:{"user-agent":`octokit-graphql.js/${qe} ${T()}`},method:"POST",url:"/graphql"});function Ce(e){return R(e,{method:"POST",url:"/graphql"})}var Ge=/^v1\./,xe=/^ghs_/,Fe=/^ghu_/;async function Le(e){const t=e.split(/\./).length===3,r=Ge.test(e)||xe.test(e),i=Fe.test(e);return{type:"token",token:e,tokenType:t?"app":r?"installation":i?"user-to-server":"oauth"}}function Be(e){return e.split(/\./).length===3?`bearer ${e}`:`token ${e}`}async function Ve(e,t,r,i){const n=t.endpoint.merge(r,i);return n.headers.authorization=Be(e),t(n)}var Me=function(t){if(!t)throw new Error("[@octokit/auth-token] No token passed to createTokenAuth");if(typeof t!="string")throw new Error("[@octokit/auth-token] Token passed to createTokenAuth is not a string");return t=t.replace(/^(token|bearer) +/i,""),Object.assign(Le.bind(null,t),{hook:Ve.bind(null,t)})},F="5.0.1",p,We=(p=class{static defaults(t){return class extends this{constructor(...i){const n=i[0]||{};if(typeof t=="function"){super(t(n));return}super(Object.assign({},t,n,n.userAgent&&t.userAgent?{userAgent:`${n.userAgent} ${t.userAgent}`}:null))}}}static plugin(...t){var n;const r=this.plugins;return n=class extends this{},n.plugins=r.concat(t.filter(a=>!r.includes(a))),n}constructor(t={}){const r=new fe,i={baseUrl:k.endpoint.DEFAULTS.baseUrl,headers:{},request:Object.assign({},t.request,{hook:r.bind(null,"request")}),mediaType:{previews:[],format:""}};if(i.headers["user-agent"]=[t.userAgent,`octokit-core.js/${F} ${T()}`].filter(Boolean).join(" "),t.baseUrl&&(i.baseUrl=t.baseUrl),t.previews&&(i.mediaType.previews=t.previews),t.timeZone&&(i.headers["time-zone"]=t.timeZone),this.request=k.defaults(i),this.graphql=Ce(this.request).defaults(i),this.log=Object.assign({debug:()=>{},info:()=>{},warn:console.warn.bind(console),error:console.error.bind(console)},t.log),this.hook=r,t.authStrategy){const{authStrategy:s,...a}=t,o=s(Object.assign({request:this.request,log:this.log,octokit:this,octokitOptions:a},t.auth));r.wrap("request",o.hook),this.auth=o}else if(!t.auth)this.auth=async()=>({type:"unauthenticated"});else{const s=Me(t.auth);r.wrap("request",s.hook),this.auth=s}this.constructor.plugins.forEach(s=>{Object.assign(this,s(this,t))})}},p.VERSION=F,p.plugins=[],p);const _="github-token",E="github-notifications",ze=te(e=>{const t=`${e.pluginSlug}-sync-notifications`,r="last-synced-notifications-at",i=async()=>{const s=await e.store.getPluginItem(_);if(!s)throw new e.GraphQLError("Missing token to access GitHub API",{extensions:{code:"NOT_AUTHENTICATED",userFriendlyMessage:"You need to add your GitHub token in the plugin settings."}});return s.value},n=async()=>{const s=await i();return new We({auth:s})};return{operations:{syncNotifications:async()=>(await e.pgBoss.send(t,{}),{data:"Job sent to sync the GitHub notifications."}),scheduleSyncNotifications:async()=>(await e.pgBoss.schedule(t,"*/5 * * * *").catch(s=>new e.GraphQLError(s)),{data:"Schedule successfully set."})},onInstall:async()=>{await e.prisma.list.upsert({where:{slug:E},create:{slug:E,name:"GitHub Notifications",description:"All your notifications from GitHub."},update:{name:"GitHub Notifications",description:"All your notifications from GitHub."}})},onStoreItemUpsert:async s=>{s===_&&(await e.pgBoss.send(t,{}),await e.pgBoss.schedule(t,"*/5 * * * *"))},handlePgBossWork:s=>[s(t,async()=>{const a=await e.store.getPluginItem(r),c=await(await n()).request("GET /notifications",{headers:{"X-GitHub-Api-Version":"2022-11-28"},all:!1,participating:!0,since:(a==null?void 0:a.value)??e.dayjs().subtract(1,"month").toISOString(),per_page:50}).catch(u=>{if(u.status===304)return null;throw new e.GraphQLError(u.message,{extensions:{code:"GITHUB_API_ERROR",userFriendlyMessage:"There was an error while fetching your GitHub notifications."}})}),f=(c==null?void 0:c.data.filter(u=>u.reason==="review_requested"))??[];for(const u of f){const l=await e.prisma.item.findFirst({where:{pluginDatas:{some:{originalId:u.id,pluginSlug:e.pluginSlug}}},include:{pluginDatas:{select:{id:!0}}}}),d={type:u.subject.type,reason:u.reason,url:u.subject.url,title:u.subject.title,updatedAt:u.updated_at},v=u;l?await e.prisma.item.update({where:{id:l.id},data:{title:u.subject.title,isRelevant:u.unread,pluginDatas:{update:{where:{id:l.pluginDatas[0].id},data:{min:d,full:v}}}}}):u.unread&&await e.prisma.item.create({data:{title:u.subject.title,isRelevant:!0,inboxPoints:11,list:{connect:{slug:E}},pluginDatas:{create:{pluginSlug:e.pluginSlug,originalId:u.id,min:d,full:v}}}})}await e.store.setItem(r,new Date().toISOString())})],onCreateTask:async({task:s})=>{var o,c;const a=(c=(o=s.item)==null?void 0:o.pluginDatas)==null?void 0:c.find(f=>f.pluginSlug===e.pluginSlug);if(a!=null&&a.originalId)return{pluginData:{originalId:a.originalId,min:a.min,full:a.full}}}}});exports.GITHUB_NOTIFICATIONS_LIST_SLUG=E;exports.TOKEN_STORE_KEY=_;exports.default=ze;
