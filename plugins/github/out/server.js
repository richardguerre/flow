"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const te=e=>({plugin:e});function E(){return typeof navigator=="object"&&"userAgent"in navigator?navigator.userAgent:"<environment undetectable>"}function re(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var T={exports:{}},ne=L;function L(e,t,r,i){if(typeof r!="function")throw new Error("method for before hook must be a function");return i||(i={}),Array.isArray(t)?t.reverse().reduce(function(n,s){return L.bind(null,e,s,n,i)},r)():Promise.resolve().then(function(){return e.registry[t]?e.registry[t].reduce(function(n,s){return s.hook.bind(null,n,i)},r)():r(i)})}var ie=ae;function ae(e,t,r,i){var n=i;e.registry[r]||(e.registry[r]=[]),t==="before"&&(i=function(s,a){return Promise.resolve().then(n.bind(null,a)).then(s.bind(null,a))}),t==="after"&&(i=function(s,a){var o;return Promise.resolve().then(s.bind(null,a)).then(function(l){return o=l,n(o,a)}).then(function(){return o})}),t==="error"&&(i=function(s,a){return Promise.resolve().then(s.bind(null,a)).catch(function(o){return n(o,a)})}),e.registry[r].push({hook:i,orig:n})}var se=oe;function oe(e,t,r){if(e.registry[t]){var i=e.registry[t].map(function(n){return n.orig}).indexOf(r);i!==-1&&e.registry[t].splice(i,1)}}var B=ne,ce=ie,ue=se,R=Function.bind,q=R.bind(R);function V(e,t,r){var i=q(ue,null).apply(null,r?[t,r]:[t]);e.api={remove:i},e.remove=i,["before","error","after","wrap"].forEach(function(n){var s=r?[t,n,r]:[t,n];e[n]=e.api[n]=q(ce,null).apply(null,s)})}function le(){var e="h",t={registry:{}},r=B.bind(null,t,e);return V(r,t,e),r}function M(){var e={registry:{}},t=B.bind(null,e);return V(t,e),t}var N=!1;function b(){return N||(console.warn('[before-after-hook]: "Hook()" repurposing warning, use "Hook.Collection()". Read more: https://git.io/upgrade-before-after-hook-to-1.4'),N=!0),M()}b.Singular=le.bind();b.Collection=M.bind();T.exports=b;T.exports.Hook=b;T.exports.Singular=b.Singular;var fe=T.exports.Collection=b.Collection;/*!
 * is-plain-object <https://github.com/jonschlinkert/is-plain-object>
 *
 * Copyright (c) 2014-2017, Jon Schlinkert.
 * Released under the MIT License.
 */function U(e){return Object.prototype.toString.call(e)==="[object Object]"}function de(e){var t,r;return U(e)===!1?!1:(t=e.constructor,t===void 0?!0:(r=t.prototype,!(U(r)===!1||r.hasOwnProperty("isPrototypeOf")===!1)))}var he="9.0.1",pe=`octokit-endpoint.js/${he} ${E()}`,ge={method:"GET",baseUrl:"https://api.github.com",headers:{accept:"application/vnd.github.v3+json","user-agent":pe},mediaType:{format:""}};function be(e){return e?Object.keys(e).reduce((t,r)=>(t[r.toLowerCase()]=e[r],t),{}):{}}function W(e,t){const r=Object.assign({},e);return Object.keys(t).forEach(i=>{de(t[i])?i in e?r[i]=W(e[i],t[i]):Object.assign(r,{[i]:t[i]}):Object.assign(r,{[i]:t[i]})}),r}function D(e){for(const t in e)e[t]===void 0&&delete e[t];return e}function A(e,t,r){var n;if(typeof t=="string"){let[s,a]=t.split(" ");r=Object.assign(a?{method:s,url:a}:{url:s},r)}else r=Object.assign({},t);r.headers=be(r.headers),D(r),D(r.headers);const i=W(e||{},r);return r.url==="/graphql"&&(e&&((n=e.mediaType.previews)!=null&&n.length)&&(i.mediaType.previews=e.mediaType.previews.filter(s=>!i.mediaType.previews.includes(s)).concat(i.mediaType.previews)),i.mediaType.previews=(i.mediaType.previews||[]).map(s=>s.replace(/-preview/,""))),i}function ye(e,t){const r=/\?/.test(e)?"&":"?",i=Object.keys(t);return i.length===0?e:e+r+i.map(n=>n==="q"?"q="+t.q.split("+").map(encodeURIComponent).join("+"):`${n}=${encodeURIComponent(t[n])}`).join("&")}var me=/\{[^}]+\}/g;function ve(e){return e.replace(/^\W+|\W+$/g,"").split(/,/)}function we(e){const t=e.match(me);return t?t.map(ve).reduce((r,i)=>r.concat(i),[]):[]}function P(e,t){return Object.keys(e).filter(r=>!t.includes(r)).reduce((r,i)=>(r[i]=e[i],r),{})}function z(e){return e.split(/(%[0-9A-Fa-f]{2})/g).map(function(t){return/%[0-9A-Fa-f]/.test(t)||(t=encodeURI(t).replace(/%5B/g,"[").replace(/%5D/g,"]")),t}).join("")}function p(e){return encodeURIComponent(e).replace(/[!'()*]/g,function(t){return"%"+t.charCodeAt(0).toString(16).toUpperCase()})}function y(e,t,r){return t=e==="+"||e==="#"?z(t):p(t),r?p(r)+"="+t:t}function h(e){return e!=null}function O(e){return e===";"||e==="&"||e==="?"}function Ee(e,t,r,i){var n=e[r],s=[];if(h(n)&&n!=="")if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")n=n.toString(),i&&i!=="*"&&(n=n.substring(0,parseInt(i,10))),s.push(y(t,n,O(t)?r:""));else if(i==="*")Array.isArray(n)?n.filter(h).forEach(function(a){s.push(y(t,a,O(t)?r:""))}):Object.keys(n).forEach(function(a){h(n[a])&&s.push(y(t,n[a],a))});else{const a=[];Array.isArray(n)?n.filter(h).forEach(function(o){a.push(y(t,o))}):Object.keys(n).forEach(function(o){h(n[o])&&(a.push(p(o)),a.push(y(t,n[o].toString())))}),O(t)?s.push(p(r)+"="+a.join(",")):a.length!==0&&s.push(a.join(","))}else t===";"?h(n)&&s.push(p(r)):n===""&&(t==="&"||t==="?")?s.push(p(r)+"="):n===""&&s.push("");return s}function Te(e){return{expand:Oe.bind(null,e)}}function Oe(e,t){var r=["+","#",".","/",";","?","&"];return e.replace(/\{([^\{\}]+)\}|([^\{\}]+)/g,function(i,n,s){if(n){let o="";const l=[];if(r.indexOf(n.charAt(0))!==-1&&(o=n.charAt(0),n=n.substr(1)),n.split(/,/g).forEach(function(u){var c=/([^:\*]*)(?::(\d+)|(\*))?/.exec(u);l.push(Ee(t,o,c[1],c[2]||c[3]))}),o&&o!=="+"){var a=",";return o==="?"?a="&":o!=="#"&&(a=o),(l.length!==0?o:"")+l.join(a)}else return l.join(",")}else return z(s)})}function K(e){var c;let t=e.method.toUpperCase(),r=(e.url||"/").replace(/:([a-z]\w+)/g,"{$1}"),i=Object.assign({},e.headers),n,s=P(e,["method","baseUrl","url","headers","request","mediaType"]);const a=we(r);r=Te(r).expand(s),/^http/.test(r)||(r=e.baseUrl+r);const o=Object.keys(e).filter(f=>a.includes(f)).concat("baseUrl"),l=P(s,o);if(!/application\/octet-stream/i.test(i.accept)&&(e.mediaType.format&&(i.accept=i.accept.split(/,/).map(f=>f.replace(/application\/vnd(\.\w+)(\.v3)?(\.\w+)?(\+json)?$/,`application/vnd$1$2.${e.mediaType.format}`)).join(",")),r.endsWith("/graphql")&&(c=e.mediaType.previews)!=null&&c.length)){const f=i.accept.match(/[\w-]+(?=-preview)/g)||[];i.accept=f.concat(e.mediaType.previews).map(d=>{const ee=e.mediaType.format?`.${e.mediaType.format}`:"+json";return`application/vnd.github.${d}-preview${ee}`}).join(",")}return["GET","HEAD"].includes(t)?r=ye(r,l):"data"in l?n=l.data:Object.keys(l).length&&(n=l),!i["content-type"]&&typeof n<"u"&&(i["content-type"]="application/json; charset=utf-8"),["PATCH","PUT"].includes(t)&&typeof n>"u"&&(n=""),Object.assign({method:t,url:r,headers:i},typeof n<"u"?{body:n}:null,e.request?{request:e.request}:null)}function Se(e,t,r){return K(A(e,t,r))}function X(e,t){const r=A(e,t),i=Se.bind(null,r);return Object.assign(i,{DEFAULTS:r,defaults:X.bind(null,r),merge:A.bind(null,r),parse:K})}var Ae=X(null,ge);/*!
 * is-plain-object <https://github.com/jonschlinkert/is-plain-object>
 *
 * Copyright (c) 2014-2017, Jon Schlinkert.
 * Released under the MIT License.
 */function H(e){return Object.prototype.toString.call(e)==="[object Object]"}function je(e){var t,r;return H(e)===!1?!1:(t=e.constructor,t===void 0?!0:(r=t.prototype,!(H(r)===!1||r.hasOwnProperty("isPrototypeOf")===!1)))}class C extends Error{constructor(t){super(t),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="Deprecation"}}var _={exports:{}},Ie=Y;function Y(e,t){if(e&&t)return Y(e)(t);if(typeof e!="function")throw new TypeError("need wrapper function");return Object.keys(e).forEach(function(i){r[i]=e[i]}),r;function r(){for(var i=new Array(arguments.length),n=0;n<i.length;n++)i[n]=arguments[n];var s=e.apply(this,i),a=i[i.length-1];return typeof s=="function"&&s!==a&&Object.keys(a).forEach(function(o){s[o]=a[o]}),s}}var J=Ie;_.exports=J(v);_.exports.strict=J(Q);v.proto=v(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return v(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return Q(this)},configurable:!0})});function v(e){var t=function(){return t.called?t.value:(t.called=!0,t.value=e.apply(this,arguments))};return t.called=!1,t}function Q(e){var t=function(){if(t.called)throw new Error(t.onceError);return t.called=!0,t.value=e.apply(this,arguments)},r=e.name||"Function wrapped with `once`";return t.onceError=r+" shouldn't be called more than once",t.called=!1,t}var ke=_.exports;const Z=re(ke);var _e=Z(e=>console.warn(e)),$e=Z(e=>console.warn(e)),m=class extends Error{constructor(e,t,r){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="HttpError",this.status=t;let i;"headers"in r&&typeof r.headers<"u"&&(i=r.headers),"response"in r&&(this.response=r.response,i=r.response.headers);const n=Object.assign({},r.request);r.request.headers.authorization&&(n.headers=Object.assign({},r.request.headers,{authorization:r.request.headers.authorization.replace(/ .*$/," [REDACTED]")})),n.url=n.url.replace(/\bclient_secret=\w+/g,"client_secret=[REDACTED]").replace(/\baccess_token=\w+/g,"access_token=[REDACTED]"),this.request=n,Object.defineProperty(this,"code",{get(){return _e(new C("[@octokit/request-error] `error.code` is deprecated, use `error.status`.")),t}}),Object.defineProperty(this,"headers",{get(){return $e(new C("[@octokit/request-error] `error.headers` is deprecated, use `error.response.headers`.")),i||{}}})}},Re="8.1.2";function qe(e){return e.arrayBuffer()}function G(e){var o,l,u;const t=e.request&&e.request.log?e.request.log:console,r=((o=e.request)==null?void 0:o.parseSuccessResponseBody)!==!1;(je(e.body)||Array.isArray(e.body))&&(e.body=JSON.stringify(e.body));let i={},n,s,{fetch:a}=globalThis;if((l=e.request)!=null&&l.fetch&&(a=e.request.fetch),!a)throw new Error("fetch is not set. Please pass a fetch implementation as new Octokit({ request: { fetch }}). Learn more at https://github.com/octokit/octokit.js/#fetch-missing");return a(e.url,{method:e.method,body:e.body,headers:e.headers,signal:(u=e.request)==null?void 0:u.signal,...e.body&&{duplex:"half"}}).then(async c=>{s=c.url,n=c.status;for(const f of c.headers)i[f[0]]=f[1];if("deprecation"in i){const f=i.link&&i.link.match(/<([^>]+)>; rel="deprecation"/),d=f&&f.pop();t.warn(`[@octokit/request] "${e.method} ${e.url}" is deprecated. It is scheduled to be removed on ${i.sunset}${d?`. See ${d}`:""}`)}if(!(n===204||n===205)){if(e.method==="HEAD"){if(n<400)return;throw new m(c.statusText,n,{response:{url:s,status:n,headers:i,data:void 0},request:e})}if(n===304)throw new m("Not modified",n,{response:{url:s,status:n,headers:i,data:await S(c)},request:e});if(n>=400){const f=await S(c);throw new m(Ne(f),n,{response:{url:s,status:n,headers:i,data:f},request:e})}return r?await S(c):c.body}}).then(c=>({status:n,url:s,headers:i,data:c})).catch(c=>{throw c instanceof m||c.name==="AbortError"?c:new m(c.message,500,{request:e})})}async function S(e){const t=e.headers.get("content-type");return/application\/json/.test(t)?e.json():!t||/^text\/|charset=utf-8$/.test(t)?e.text():qe(e)}function Ne(e){return typeof e=="string"?e:"message"in e?Array.isArray(e.errors)?`${e.message}: ${e.errors.map(JSON.stringify).join(", ")}`:e.message:`Unknown error: ${JSON.stringify(e)}`}function j(e,t){const r=e.defaults(t);return Object.assign(function(n,s){const a=r.merge(n,s);if(!a.request||!a.request.hook)return G(r.parse(a));const o=(l,u)=>G(r.parse(r.merge(l,u)));return Object.assign(o,{endpoint:r,defaults:j.bind(null,r)}),a.request.hook(o,a)},{endpoint:r,defaults:j.bind(null,r)})}var I=j(Ae,{headers:{"user-agent":`octokit-request.js/${Re} ${E()}`}}),Ue="7.0.2";function De(e){return`Request failed due to following response errors:
`+e.errors.map(t=>` - ${t.message}`).join(`
`)}var Pe=class extends Error{constructor(e,t,r){super(De(r)),this.request=e,this.headers=t,this.response=r,this.name="GraphqlResponseError",this.errors=r.errors,this.data=r.data,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},He=["method","baseUrl","url","headers","request","query","mediaType"],Ce=["query","method","url"],x=/\/api\/v3\/?$/;function Ge(e,t,r){if(r){if(typeof t=="string"&&"query"in r)return Promise.reject(new Error('[@octokit/graphql] "query" cannot be used as variable name'));for(const a in r)if(Ce.includes(a))return Promise.reject(new Error(`[@octokit/graphql] "${a}" cannot be used as variable name`))}const i=typeof t=="string"?Object.assign({query:t},r):t,n=Object.keys(i).reduce((a,o)=>He.includes(o)?(a[o]=i[o],a):(a.variables||(a.variables={}),a.variables[o]=i[o],a),{}),s=i.baseUrl||e.endpoint.DEFAULTS.baseUrl;return x.test(s)&&(n.url=s.replace(x,"/api/graphql")),e(n).then(a=>{if(a.data.errors){const o={};for(const l of Object.keys(a.headers))o[l]=a.headers[l];throw new Pe(n,o,a.data)}return a.data.data})}function $(e,t){const r=e.defaults(t);return Object.assign((n,s)=>Ge(r,n,s),{defaults:$.bind(null,r),endpoint:r.endpoint})}$(I,{headers:{"user-agent":`octokit-graphql.js/${Ue} ${E()}`},method:"POST",url:"/graphql"});function xe(e){return $(e,{method:"POST",url:"/graphql"})}var Fe=/^v1\./,Le=/^ghs_/,Be=/^ghu_/;async function Ve(e){const t=e.split(/\./).length===3,r=Fe.test(e)||Le.test(e),i=Be.test(e);return{type:"token",token:e,tokenType:t?"app":r?"installation":i?"user-to-server":"oauth"}}function Me(e){return e.split(/\./).length===3?`bearer ${e}`:`token ${e}`}async function We(e,t,r,i){const n=t.endpoint.merge(r,i);return n.headers.authorization=Me(e),t(n)}var ze=function(t){if(!t)throw new Error("[@octokit/auth-token] No token passed to createTokenAuth");if(typeof t!="string")throw new Error("[@octokit/auth-token] Token passed to createTokenAuth is not a string");return t=t.replace(/^(token|bearer) +/i,""),Object.assign(Ve.bind(null,t),{hook:We.bind(null,t)})},F="5.0.1",g,Ke=(g=class{static defaults(t){return class extends this{constructor(...i){const n=i[0]||{};if(typeof t=="function"){super(t(n));return}super(Object.assign({},t,n,n.userAgent&&t.userAgent?{userAgent:`${n.userAgent} ${t.userAgent}`}:null))}}}static plugin(...t){var n;const r=this.plugins;return n=class extends this{},n.plugins=r.concat(t.filter(a=>!r.includes(a))),n}constructor(t={}){const r=new fe,i={baseUrl:I.endpoint.DEFAULTS.baseUrl,headers:{},request:Object.assign({},t.request,{hook:r.bind(null,"request")}),mediaType:{previews:[],format:""}};if(i.headers["user-agent"]=[t.userAgent,`octokit-core.js/${F} ${E()}`].filter(Boolean).join(" "),t.baseUrl&&(i.baseUrl=t.baseUrl),t.previews&&(i.mediaType.previews=t.previews),t.timeZone&&(i.headers["time-zone"]=t.timeZone),this.request=I.defaults(i),this.graphql=xe(this.request).defaults(i),this.log=Object.assign({debug:()=>{},info:()=>{},warn:console.warn.bind(console),error:console.error.bind(console)},t.log),this.hook=r,t.authStrategy){const{authStrategy:s,...a}=t,o=s(Object.assign({request:this.request,log:this.log,octokit:this,octokitOptions:a},t.auth));r.wrap("request",o.hook),this.auth=o}else if(!t.auth)this.auth=async()=>({type:"unauthenticated"});else{const s=ze(t.auth);r.wrap("request",s.hook),this.auth=s}this.constructor.plugins.forEach(s=>{Object.assign(this,s(this,t))})}},g.VERSION=F,g.plugins=[],g);const k="github-token",w="github-notifications",Xe=te(e=>{const t=`${e.pluginSlug}-sync-notifications`,r="last-synced-notifications-at",i=async()=>{const n=await e.store.getPluginItem(k);if(!n)throw new e.GraphQLError("Missing token to access GitHub API",{extensions:{code:"NOT_AUTHENTICATED",userFriendlyMessage:"You need to add your GitHub token in the plugin settings."}});return new Ke({auth:n.value})};return{operations:{syncNotifications:async()=>(await e.pgBoss.send(t,{}),{data:"Job sent to sync the GitHub notifications."}),scheduleSyncNotifications:async()=>(await e.pgBoss.schedule(t,"*/5 * * * *").catch(n=>new e.GraphQLError(n)),{data:"Schedule successfully set."})},onInstall:async()=>{await e.prisma.list.upsert({where:{slug:w},create:{slug:w,name:"GitHub Notifications",description:"All your notifications from GitHub."},update:{name:"GitHub Notifications",description:"All your notifications from GitHub."}})},onStoreItemUpsert:async n=>{n===k&&(await e.pgBoss.send(t,{}),await e.pgBoss.schedule(t,"*/5 * * * *"))},handlePgBossWork:n=>[n(t,async()=>{const s=await e.store.getPluginItem(r),o=await(await i()).request("GET /notifications",{headers:{"X-GitHub-Api-Version":"2022-11-28"},all:!1,participating:!0,since:(s==null?void 0:s.value)??e.dayjs().subtract(1,"month").toISOString(),per_page:50}).catch(u=>{if(u.status===304)return null;throw new e.GraphQLError(u.message,{extensions:{code:"GITHUB_API_ERROR",userFriendlyMessage:"There was an error while fetching your GitHub notifications."}})}),l=(o==null?void 0:o.data.filter(u=>u.reason==="review_requested"))??[];for(const u of l){const c=await e.prisma.item.findFirst({where:{pluginDatas:{some:{originalId:u.id,pluginSlug:e.pluginSlug}}},include:{pluginDatas:{select:{id:!0}}}}),f={type:u.subject.type,reason:u.reason,url:u.subject.url,title:u.subject.title,updatedAt:u.updated_at},d=u;c?await e.prisma.item.update({where:{id:c.id},data:{title:u.subject.title,isRelevant:!0,pluginDatas:{update:{where:{id:c.pluginDatas[0].id},data:{min:f,full:d}}}}}):await e.prisma.item.create({data:{title:u.subject.title,isRelevant:!0,inboxPoints:11,list:{connect:{slug:w}},pluginDatas:{create:{pluginSlug:e.pluginSlug,originalId:u.id,min:f,full:d}}}})}await e.store.setItem(r,new Date().toISOString())})]}});exports.GITHUB_NOTIFICATIONS_LIST_SLUG=w;exports.TOKEN_STORE_KEY=k;exports.default=Xe;
